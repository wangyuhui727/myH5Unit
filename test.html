<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ImageLayer</title>
    <meta id="viewport" name="viewport"
        content="width=device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0" />
    <style>
        html,
        body,
        #container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #canvas {
            /* background: #ffffff;
            border: 1px solid #ccc;
            box-sizing: border-box;
            cursor: pointer; */
        }
    </style>
</head>

<body>
    <div id="container"></div>
    <script src="http://webapi.amap.com/maps?v=1.4.15&key=2a8648d9248167e00d8c0f07a80b10d7"></script>
    <script>
        var map = new AMap.Map('container', {
            resizeEnable: true,
            zoom: 15,
            center: [116.335183, 39.941735]
        });

        AMap.plugin(["AMap.ControlBar"], function () {
            var bar = new AMap.ControlBar();
            map.addControl(bar);
        });


        var width = undefined,
            height = undefined;
        var pixels = [];
        var coloredPixels = [];
        var colors = ['#ACFFE9', '#540045', '#C60052', '#FF714B', '#EAFF87', '#ACFFE9'];
        var currentPixel = 0;
        var mousePosition = {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2
        };
        var count = 0;

        var pLeftTop = [116.328911, 39.937229];
        var pRightTop = [116.342659, 39.937229];
        var dWidth = AMap.GeometryUtil.distance(pLeftTop, pRightTop);

        var pLeftTop = [116.328911, 39.937229];
        var pLeftDown = [116.328911, 39.946275];
        var dHeight = AMap.GeometryUtil.distance(pLeftTop, pLeftDown);

        console.log(dWidth, dHeight);

        var xCount = Math.floor(dWidth / 50);
        var yCount = Math.floor(dHeight / 50);

        console.log(xCount, yCount);

        var width = xCount * 50;
        var height = yCount * 50;

        // var xCount = dWidth / 50;
        // var yCount = dHeight / 50;

        console.log(width, height);

        var xRate = dWidth / width;
        var yRate = dHeight / height;

        /*
         * 添加Canvas图层
         */
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d')
        canvas.width = width;
        canvas.height = height;

        var drawGrid = function drawGrid() {
            ctx.clearRect(0, 0, width, height);

            for (var i = 0, l = pixels.length; i < l; i++) {
                ctx.globalAlpha = pixels[i][5];
                ctx.fillStyle = pixels[i][4];
                ctx.fillRect(pixels[i][0], pixels[i][1], pixels[i][2], pixels[i][3]);
            }
        };

        // var initColoredPixels = function initColoredPixels() {
        //     for (var i = 0; i < 1; i++) {
        //         coloredPixels.push({
        //             x: width / 2,
        //             y: height / 2,
        //             alpha: 0,
        //             color: colors[i % 5],
        //             vx: -1 + Math.random() * 2,
        //             vy: -1 + Math.random() * 2
        //         });
        //     }
        // };

        // var launchPixel = function launchPixel() {
        //     coloredPixels[currentPixel].x = mousePosition.x;
        //     coloredPixels[currentPixel].y = mousePosition.y;
        //     coloredPixels[currentPixel].alpha = 1;

        //     currentPixel++;
        //     if (currentPixel > 0) currentPixel = 0;
        // };

        var resize = function resize() {
            pixels = [];
            for (var y = 0; y < yCount; y++) {
                for (var x = 0; x < xCount; x++) {
                    pixels.push([x * 50, y * 50, 49, 49, '#000', 1]);
                }
            }
        };

        var draw = function () {
            // launchPixel();
            // launchPixel();
            drawGrid();
            AMap.Util.requestAnimFrame(draw);
        };

        var CanvasLayer = new AMap.CanvasLayer({
            canvas: canvas,
            bounds: new AMap.Bounds(
                [116.328911, 39.937229],
                [116.342659, 39.946275]
            ),
            zooms: [3, 18],
        });

        CanvasLayer.setMap(map);

        resize();
        // initColoredPixels();
        draw();

        map.on('click', showInfoClick);

        function showInfoClick(e) {
            var curPoint = [e.lnglat.getLng(), e.lnglat.getLat()];

            var point1 = [pLeftDown[0], e.lnglat.getLat()];
            var dMarginLeft = AMap.GeometryUtil.distance(curPoint, point1);

            var point2 = [e.lnglat.getLng(), pLeftDown[1]];
            var dMarginTop = AMap.GeometryUtil.distance(curPoint, point2);

            console.log(dMarginLeft / xRate, dMarginTop / yRate);

            var index = Math.floor(dMarginTop / yRate / 50) * xCount + Math.floor(dMarginLeft / xRate / 50);

            if (pixels[index][4] == '#00f')
                pixels[index][4] = '#000';
            else
                pixels[index][4] = '#00f';
        }
		
    </script>
</body>

</html>